<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DailyOS - Transaction Section (Dark Mode)</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Feather Icons for a clean UI -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* Custom styles to complement Tailwind CSS */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* bg-slate-900 */
        }
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; } /* bg-slate-800 */
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 8px; } /* bg-slate-600 */
        ::-webkit-scrollbar-thumb:hover { background: #64748b; } /* bg-slate-500 */
        
        /* Custom class for highlighting over-expenditure */
        .over-expenditure-alert {
            background-color: rgba(153, 27, 27, 0.2); /* bg-red-800/20 */
            border-left: 4px solid #ef4444; /* border-red-500 */
            color: #f87171; /* text-red-400 */
        }
        .over-expenditure-alert .balance { color: #f87171; } /* text-red-400 */
        
        /* Modal styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(15, 23, 42, 0.8); /* bg-slate-900/80 */
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
            width: 100%;
        }
        .modal-backdrop.active {
            display: flex;
            opacity: 1;
        }
        .block{
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #1e293b;
            background-color: rgb(59, 73, 73);
            color: #0f172a;
            border-radius: 20px;
            border-color: black;
            margin-bottom: 10px;
        }
        .form{
            background-color: rgba(105, 123, 123, 0.858);
            border: 1px solid #1e293b;
            border-radius: 8px;
            border-color: black;
            font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        }
        .modal-backdrop.active .modal-content {
            transform: scale(1);
        }
        /* Custom dark-mode input styles */
        .form {
             @apply mt-1 block w-full bg-slate-700 border-slate-600 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 transition;
        }
         .form-select-dark {
             @apply border border-slate-600 bg-slate-700 text-gray-200 rounded-md p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition;
        }
    </style>
</head>
<body class="antialiased text-gray-300">
    <!-- Main Content Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex flex-wrap gap-4 justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-white">Transactions</h1>
                <p class="text-gray-400 mt-1">Manage your finances across all your accounts.</p>
            </div>
            <button id="add-transaction-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center font-semibold shadow-md shadow-green-900/50">
                <i data-feather="plus" class="w-5 h-5 mr-2"></i> Add Transaction
            </button>
        </header>

        <!-- Summary Dashboard -->
        <section id="summary-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Balance Card -->
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-400">Total Balance</p>
                    <p id="total-balance" class="text-2xl font-bold text-white mt-1">₹0.00</p>
                </div>
                <div class="bg-slate-700 text-blue-400 p-3 rounded-full">
                    <i data-feather="dollar-sign" class="w-6 h-6"></i>
                </div>
            </div>
            <!-- Total Inflow Card -->
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-400">Total Inflow</p>
                    <p id="total-inflow" class="text-2xl font-bold text-green-400 mt-1">₹0.00</p>
                </div>
                <div class="bg-slate-700 text-green-400 p-3 rounded-full">
                    <i data-feather="arrow-down-left" class="w-6 h-6"></i>
                </div>
            </div>
            <!-- Total Outflow Card -->
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-400">Total Outflow</p>
                    <p id="total-outflow" class="text-2xl font-bold text-red-400 mt-1">₹0.00</p>
                </div>
                 <div class="bg-slate-700 text-red-400 p-3 rounded-full">
                    <i data-feather="arrow-up-right" class="w-6 h-6"></i>
                </div>
            </div>
             <!-- Net Flow Card -->
             <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-400">Net Flow</p>
                    <p id="net-flow" class="text-2xl font-bold text-gray-200 mt-1">₹0.00</p>
                </div>
                 <div class="bg-slate-700 text-gray-400 p-3 rounded-full">
                    <i data-feather="bar-chart-2" class="w-6 h-6"></i>
                </div>
            </div>
        </section>

        <!-- Accounts and Transactions Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Accounts List -->
            <div class="lg:col-span-1">
                <h2 class="text-xl font-semibold text-white mb-4">Your Accounts</h2>
                <div id="accounts-list" class="space-y-4">
                    <!-- Account cards will be dynamically inserted here -->
                </div>
                 <button id="add-account-btn" class="w-full mt-4 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center font-semibold shadow-md shadow-blue-900/50">
                    <i data-feather="plus" class="w-5 h-5 mr-2"></i> Add New Account
                </button>
            </div>

            <!-- Right Column: Transaction Details -->
            <div class="lg:col-span-2">
                <div class="bg-slate-800 p-4 sm:p-6 rounded-xl border border-slate-700">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
                        <h2 id="transaction-header" class="text-xl font-semibold text-white">All Transactions</h2>
                         <div class="flex items-center space-x-2">
                            <label for="account-selector" class="text-sm font-medium text-gray-400">View:</label>
                            <select id="account-selector" class="form-select-dark w-full sm:w-auto">
                                <!-- Options will be dynamically inserted here -->
                            </select>
                        </div>
                    </div>

                    <!-- Filter & Search -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <input type="date" id="filter-date" class="form-select-dark">
                        <select id="filter-category" class="form-select-dark">
                           <option value="">All Categories</option>
                           <!-- Categories will be dynamically inserted here -->
                        </select>
                         <select id="filter-type" class="form-select-dark">
                           <option value="">All Types</option>
                           <option value="credit">Credit</option>
                           <option value="debit">Debit</option>
                        </select>
                        <input type="text" id="search-description" placeholder="Search..." class="form-select-dark">
                    </div>

                    <!-- Transaction History Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-700">
                            <thead class="bg-slate-700/50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-table-body" class="bg-slate-800 divide-y divide-slate-700">
                                <!-- Transaction rows will be dynamically inserted here -->
                            </tbody>
                            <tfoot id="transaction-table-footer">
                                <!-- "See More" button will be injected here -->
                            </tfoot>
                        </table>
                        <p id="no-transactions-message" class="text-center py-8 text-gray-500 hidden">No transactions found.</p>
                    </div>
                </div>

                <!-- Visual Charts -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mt-8">
                    <div class="bg-slate-800 p-4 sm:p-6 rounded-xl border border-slate-700">
                        <h3 class="text-lg font-semibold text-white mb-4">Monthly Flow</h3>
                        <div class="relative h-64 sm:h-72">
                            <canvas id="monthly-flow-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-slate-800 p-4 sm:p-6 rounded-xl border border-slate-700">
                        <h3 class="text-lg font-semibold text-white mb-4">Expense Distribution</h3>
                        <div class="relative h-64 sm:h-72">
                            <canvas id="category-spending-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Account Modal -->
    <div id="add-account-modal" class="modal-backdrop">
        <div class="modal-content bg-slate-800 border border-slate-700 max-w-md p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-white mb-4">Add New Account</h2>
            <form id="add-account-form">
                <div class="mb-4">
                    <label for="account-name" class="block">Account Name</label>
                    <input type="text" id="account-name" required class="form">
                </div>
                <div class="mb-4">
                    <label for="account-type" class="block">Account Type</label>
                    <input type="text" id="account-type" placeholder="e.g., Bank, Wallet, UPI" required class="form">
                </div>
                <div class="mb-6">
                    <label for="account-balance" class="block">Opening Balance</label>
                    <input type="number" id="account-balance" step="0.01" required class="form">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn bg-slate-600 text-gray-200 py-2 px-4 rounded-lg hover:bg-slate-500">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">Add Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div id="edit-account-modal" class="modal-backdrop">
        <div class="modal-content bg-slate-800 border border-slate-700 max-w-md p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-white mb-4">Edit Account</h2>
            <form id="edit-account-form">
                <input type="hidden" id="edit-account-id">
                <div class="mb-4">
                    <label for="edit-account-name" class="block">Account Name</label>
                    <input type="text" id="edit-account-name" required class="form">
                </div>
                <div class="mb-6">
                    <label for="edit-account-type" class="block">Account Type</label>
                    <input type="text" id="edit-account-type" placeholder="e.g., Bank, Wallet, UPI" required class="form">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn bg-slate-600 text-gray-200 py-2 px-4 rounded-lg hover:bg-slate-500">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Transaction Modal -->
    <div id="transaction-modal" class="modal-backdrop">
        <div class="modal-content bg-slate-800 border border-slate-700 max-w-md p-6 rounded-xl">
            <h2 id="transaction-modal-title" class="text-2xl font-bold text-white mb-4">Add Transaction</h2>
            <form id="transaction-form">
                <input type="hidden" id="transaction-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="sm:col-span-2">
                        <label for="transaction-account" class="block ">Account</label>
                        <select id="transaction-account" required class="form">
                            <!-- Account options will be populated here -->
                        </select>
                    </div>
                     <div>
                        <label for="transaction-date" class="block">Date</label>
                        <input type="date" id="transaction-date" required class="form">
                    </div>
                    <div>
                        <label for="transaction-type" class="block">Type</label>
                        <select id="transaction-type" required class="form">
                            <option value="debit">Debit (Expense)</option>
                            <option value="credit">Credit (Income)</option>
                        </select>
                    </div>
                     <div class="sm:col-span-2">
                        <label for="transaction-description" class="block">Description</label>
                        <input type="text" id="transaction-description" required class="form">
                    </div>
                    <div>
                        <label for="transaction-amount" class="block">Amount</label>
                        <input type="number" id="transaction-amount" step="0.01" min="0" required class="form">
                    </div>
                    <div>
                        <label for="transaction-category" class="block">Category</label>
                        <input type="text" id="transaction-category" required class="form">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" class="modal-close-btn bg-slate-600 text-gray-200 py-2 px-4 rounded-lg hover:bg-slate-500">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content bg-slate-800 border border-slate-700 max-w-sm p-6 rounded-xl">
             <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50">
                    <i data-feather="alert-triangle" class="h-6 w-6 text-red-400"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-white mt-4">Delete Confirmation</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-400" id="confirm-modal-text">
                        Are you sure you want to delete this? This action cannot be undone.
                    </p>
                </div>
                <div class="flex justify-center space-x-3 mt-4">
                    <button id="confirm-cancel-btn" class="bg-slate-600 text-gray-200 py-2 px-4 rounded-lg hover:bg-slate-500 w-24">Cancel</button>
                    <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 w-24">Delete</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DARK MODE CHART DEFAULTS ---
            Chart.defaults.color = '#94a3b8'; // text-slate-400
            Chart.defaults.borderColor = '#335655'; // border-slate-700
            
            // --- STATE MANAGEMENT (Simulates backend database) ---
            let data = {
    accounts: [
        { 
            id: 1, 
            name: "Main Bank Account", 
            type: "Bank", 
            balance: 0, 
            transactions: [] 
        },
        { 
            id: 2, 
            name: "Digital Wallet", 
            type: "Wallet", 
            balance: 0, 
            transactions: [] 
        },
        { 
            id: 3, 
            name: "Cash in Hand", 
            type: "Cash", 
            balance: 0, 
            transactions: [] 
        }
    ]
};
            
            // --- DOM ELEMENT REFERENCES ---
            const accountsListEl = document.getElementById('accounts-list');
            const accountSelectorEl = document.getElementById('account-selector');
            const transactionTableBodyEl = document.getElementById('transaction-table-body');
            const transactionHeaderEl = document.getElementById('transaction-header');
            const totalBalanceEl = document.getElementById('total-balance');
            const totalInflowEl = document.getElementById('total-inflow');
            const totalOutflowEl = document.getElementById('total-outflow');
            const netFlowEl = document.getElementById('net-flow');
            const noTransactionsMessageEl = document.getElementById('no-transactions-message');
            
            // Filter elements
            const filterDateEl = document.getElementById('filter-date');
            const filterCategoryEl = document.getElementById('filter-category');
            const filterTypeEl = document.getElementById('filter-type');
            const searchDescriptionEl = document.getElementById('search-description');

            // Modals & Forms
            const addAccountModal = document.getElementById('add-account-modal');
            const editAccountModal = document.getElementById('edit-account-modal');
            const transactionModal = document.getElementById('transaction-modal');
            const confirmModal = document.getElementById('confirm-modal');
            const addAccountForm = document.getElementById('add-account-form');
            const editAccountForm = document.getElementById('edit-account-form');
            const transactionForm = document.getElementById('transaction-form');

            let allTransactions = [];
            let chartInstances = {};
            let confirmCallback = null;

            // --- MAIN REFRESH FUNCTION ---
            function refreshUI() {
                allTransactions = data.accounts.flatMap(acc => 
                    acc.transactions.map(t => ({...t, accountName: acc.name, accountId: acc.id}))
                );
                
                const currentAccountFilter = accountSelectorEl.value || 'all';

                populateAccountSelector();
                populateCategoryFilter();
                updateDashboardSummary();
                renderAccountsList();
                
                accountSelectorEl.value = currentAccountFilter;
                handleFilterChange(); 
                
                feather.replace();
            }

            // --- EVENT LISTENERS SETUP ---
            function setupEventListeners() {
                accountSelectorEl.addEventListener('change', handleFilterChange);
                filterDateEl.addEventListener('change', handleFilterChange);
                filterCategoryEl.addEventListener('change', handleFilterChange);
                filterTypeEl.addEventListener('change', handleFilterChange);
                searchDescriptionEl.addEventListener('input', handleFilterChange);

                document.getElementById('add-account-btn').addEventListener('click', () => openModal(addAccountModal));
                document.getElementById('add-transaction-btn').addEventListener('click', () => openTransactionModal());

                document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal-backdrop'))));
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.addEventListener('click', (e) => {
                    if (e.target === backdrop) closeModal(backdrop);
                }));

                addAccountForm.addEventListener('submit', handleAddAccount);
                editAccountForm.addEventListener('submit', handleEditAccount);
                transactionForm.addEventListener('submit', handleAddEditTransaction);

                document.body.addEventListener('click', (e) => {
                    const editTxBtn = e.target.closest('.edit-btn');
                    const deleteTxBtn = e.target.closest('.delete-btn');
                    const editAccBtn = e.target.closest('.edit-account-btn');
                    const deleteAccBtn = e.target.closest('.delete-account-btn');

                    if (editTxBtn) {
                        openTransactionModal(parseInt(editTxBtn.dataset.id));
                    }
                    if (deleteTxBtn) {
                        const transactionId = parseInt(deleteTxBtn.dataset.id);
                        const message = "Are you sure you want to delete this transaction? This action cannot be undone.";
                        openConfirmModal(message, () => handleDeleteTransaction(transactionId));
                    }
                    if (editAccBtn) {
                        openEditAccountModal(parseInt(editAccBtn.dataset.id));
                    }
                    if (deleteAccBtn) {
                        const accountId = parseInt(deleteAccBtn.dataset.id);
                        const message = "Are you sure you want to delete this account? All associated transactions will also be permanently deleted.";
                        openConfirmModal(message, () => handleDeleteAccount(accountId));
                    }
                });

                document.getElementById('confirm-delete-btn').addEventListener('click', () => {
                    if (typeof confirmCallback === 'function') {
                        confirmCallback();
                    }
                });
                document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeModal(confirmModal));
            }
            
            // --- DATA POPULATION & RENDERING ---
            function populateAccountSelector() {
                const transactionAccountSelect = document.getElementById('transaction-account');
                accountSelectorEl.innerHTML = '<option value="all">All Accounts</option>';
                transactionAccountSelect.innerHTML = '';
                
                data.accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.name} (${account.type})`;
                    accountSelectorEl.appendChild(option.cloneNode(true));
                    transactionAccountSelect.appendChild(option.cloneNode(true));
                });
            }

            function populateCategoryFilter() {
                const currentCategory = filterCategoryEl.value;
                filterCategoryEl.innerHTML = '<option value="">All Categories</option>';
                const categories = [...new Set(allTransactions.map(t => t.category))];
                categories.sort().forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    filterCategoryEl.appendChild(option);
                });
                filterCategoryEl.value = currentCategory;
            }

            function updateDashboardSummary() {
                const totalBalance = data.accounts.reduce((sum, acc) => sum + acc.balance, 0);
                const totalInflow = allTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                const totalOutflow = allTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                const netFlow = totalInflow - totalOutflow;

                totalBalanceEl.textContent = formatCurrency(totalBalance);
                totalInflowEl.textContent = formatCurrency(totalInflow);
                totalOutflowEl.textContent = formatCurrency(totalOutflow);
                netFlowEl.textContent = formatCurrency(netFlow);
                
                netFlowEl.classList.toggle('text-green-400', netFlow >= 0);
                netFlowEl.classList.toggle('text-red-400', netFlow < 0);
            }

            function renderAccountsList() {
                accountsListEl.innerHTML = '';
                data.accounts.forEach(account => {
                    const inflow = account.transactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                    const outflow = account.transactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                    
                    const isOverSpent = outflow > inflow && account.transactions.length > 0;
                    const alertClass = isOverSpent ? 'over-expenditure-alert' : 'bg-slate-800 border border-slate-700';

                    const accountCard = `<div class="p-5 rounded-xl transition-shadow ${alertClass}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0">
                                    <p class="font-semibold text-gray-100 truncate">${account.name}</p>
                                    <p class="text-sm text-gray-400">${account.type}</p>
                                </div>
                                <div class="flex items-center space-x-1 flex-shrink-0 ml-2">
                                    <button class="edit-account-btn text-gray-500 hover:text-blue-400 p-1 rounded-full" data-id="${account.id}" title="Edit Account"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                    <button class="delete-account-btn text-gray-500 hover:text-red-400 p-1 rounded-full" data-id="${account.id}" title="Delete Account"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <div class="mt-4 cursor-pointer" onclick="selectAccountFromCard(${account.id})">
                                <p class="text-sm text-gray-400">Balance</p><p class="text-2xl font-bold balance text-white">${formatCurrency(account.balance)}</p>
                                <div class="mt-4 flex justify-between text-sm">
                                    <div><p class="text-gray-400 flex items-center"><i data-feather="arrow-down" class="w-4 h-4 mr-1 text-green-400"></i> Inflow</p><p class="font-medium text-green-400">${formatCurrency(inflow)}</p></div>
                                    <div><p class="text-gray-400 flex items-center"><i data-feather="arrow-up" class="w-4 h-4 mr-1 text-red-400"></i> Outflow</p><p class="font-medium text-red-400">${formatCurrency(outflow)}</p></div>
                                </div>
                            </div>
                        </div>`;
                    accountsListEl.insertAdjacentHTML('beforeend', accountCard);
                });
            }

            function renderTransactionTable(transactions, showAll = false) {
                const transactionTableFooterEl = document.getElementById('transaction-table-footer');
                
                transactionTableBodyEl.innerHTML = '';
                transactionTableFooterEl.innerHTML = ''; // Clear footer on each render
                noTransactionsMessageEl.classList.toggle('hidden', transactions.length > 0);

                const sortedTransactions = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const hasMoreThanTen = sortedTransactions.length > 10;
                const transactionsToRender = (hasMoreThanTen && !showAll) ? sortedTransactions.slice(0, 10) : sortedTransactions;

                transactionsToRender.forEach(t => {
                    const typeClass = t.type === 'credit' ? 'text-green-400 bg-green-900/50' : 'text-red-400 bg-red-900/50';
                    const amountSign = t.type === 'credit' ? '+' : '-';
                    const row = `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${new Date(t.date).toLocaleDateString('en-CA')}</td>
                            <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-100">${t.description}</div><div class="text-xs text-gray-500">${t.accountName}</div></td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${amountSign} ${formatCurrency(t.amount)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}">${t.type}</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${t.category}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                <button class="edit-btn text-blue-400 hover:text-blue-300" data-id="${t.id}"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                                <button class="delete-btn text-red-400 hover:text-red-300 ml-2" data-id="${t.id}"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                            </td></tr>`;
                    transactionTableBodyEl.insertAdjacentHTML('beforeend', row);
                });

                if (hasMoreThanTen) {
                    const buttonText = showAll ? 'Show Less...' : 'See More...';
                    const newShowAllState = !showAll;
                    const footerRow = `
                        <tr>
                            <td colspan="6" class="text-center py-3 bg-slate-800/50">
                                <button class="toggle-transactions-btn text-blue-400 hover:text-blue-300 font-semibold text-sm">${buttonText}</button>
                            </td>
                        </tr>
                    `;
                    transactionTableFooterEl.innerHTML = footerRow;
                    document.querySelector('.toggle-transactions-btn').addEventListener('click', () => {
                        renderTransactionTable(transactions, newShowAllState);
                    });
                }

                feather.replace();
            }

            // --- FILTERING LOGIC ---
            function handleFilterChange() {
                const filters = {
                    accountId: accountSelectorEl.value,
                    date: filterDateEl.value,
                    category: filterCategoryEl.value,
                    type: filterTypeEl.value,
                    search: searchDescriptionEl.value.toLowerCase()
                };

                let filtered = allTransactions.filter(t => 
                    (filters.accountId === 'all' || t.accountId == filters.accountId) &&
                    (!filters.date || t.date === filters.date) &&
                    (!filters.category || t.category === filters.category) &&
                    (!filters.type || t.type === filters.type) &&
                    (!filters.search || t.description.toLowerCase().includes(filters.search))
                );

                transactionHeaderEl.textContent = filters.accountId === 'all' 
                    ? 'All Transactions' 
                    : `${data.accounts.find(a=>a.id==filters.accountId).name} Transactions`;

                renderTransactionTable(filtered);
                updateCharts(filters.accountId, filtered);
            }
            window.selectAccountFromCard = (accountId) => {
                accountSelectorEl.value = accountId;
                handleFilterChange();
            };
            
            // --- DATA MANIPULATION (CRUD Operations) ---
            function handleAddAccount(e) { e.preventDefault();
                data.accounts.push({ id: Date.now(), name: document.getElementById('account-name').value, type: document.getElementById('account-type').value, balance: parseFloat(document.getElementById('account-balance').value), transactions: [] });
                closeModal(addAccountModal); addAccountForm.reset(); refreshUI();
            }

            function handleEditAccount(e) {
                e.preventDefault();
                const accountId = parseInt(document.getElementById('edit-account-id').value);
                const account = data.accounts.find(a => a.id === accountId);
                if (account) {
                    account.name = document.getElementById('edit-account-name').value;
                    account.type = document.getElementById('edit-account-type').value;
                }
                closeModal(editAccountModal);
                editAccountForm.reset();
                refreshUI();
            }

            function handleAddEditTransaction(e) {
                e.preventDefault();
                const transactionId = parseInt(document.getElementById('transaction-id').value);
                const accountId = parseInt(document.getElementById('transaction-account').value);
                const amount = parseFloat(document.getElementById('transaction-amount').value);
                const type = document.getElementById('transaction-type').value;

                const formData = {
                    date: document.getElementById('transaction-date').value,
                    description: document.getElementById('transaction-description').value,
                    amount, type, category: document.getElementById('transaction-category').value
                };

                if (transactionId) { // Editing
                    let oldTransaction, oldAccount;
                    for(let acc of data.accounts) {
                        const tx = acc.transactions.find(t => t.id === transactionId);
                        if(tx) { oldTransaction = tx; oldAccount = acc; break; }
                    }
                    // Revert old transaction from its original account
                    oldAccount.balance += (oldTransaction.type === 'credit' ? -oldTransaction.amount : oldTransaction.amount);
                    // If account changed, remove from old account
                    if (oldAccount.id !== accountId) {
                        oldAccount.transactions = oldAccount.transactions.filter(t => t.id !== transactionId);
                    }
                }
                
                const targetAccount = data.accounts.find(a => a.id === accountId);
                const existingTransaction = targetAccount.transactions.find(t => t.id === transactionId);

                if(existingTransaction) { // Update in place
                    Object.assign(existingTransaction, formData);
                } else { // Add as new or moved
                    targetAccount.transactions.push({ ...formData, id: transactionId || Date.now() });
                }

                targetAccount.balance += (type === 'credit' ? amount : -amount);
                closeModal(transactionModal); transactionForm.reset(); refreshUI();
            }

            function handleDeleteTransaction(transactionId) {
                let accountOfTransaction, transactionIndex = -1;
                for (const account of data.accounts) {
                    const index = account.transactions.findIndex(t => t.id === transactionId);
                    if (index !== -1) { accountOfTransaction = account; transactionIndex = index; break; }
                }

                if (accountOfTransaction) {
                    const transaction = accountOfTransaction.transactions[transactionIndex];
                    accountOfTransaction.balance += (transaction.type === 'credit' ? -transaction.amount : transaction.amount);
                    accountOfTransaction.transactions.splice(transactionIndex, 1);
                    closeModal(confirmModal);
                    confirmCallback = null;
                    refreshUI();
                }
            }

            function handleDeleteAccount(accountId) {
                data.accounts = data.accounts.filter(a => a.id !== accountId);
                // If the deleted account was selected in the filter, switch to 'All Accounts'
                if (accountSelectorEl.value == accountId) {
                    accountSelectorEl.value = 'all';
                }
                closeModal(confirmModal);
                confirmCallback = null;
                refreshUI();
            }
            
            // --- MODAL CONTROLS ---
            function openModal(modalEl) { modalEl.classList.add('active'); }
            function closeModal(modalEl) { 
                modalEl.classList.remove('active');
                if (modalEl.id === 'confirm-modal') {
                    confirmCallback = null; // Reset callback when confirmation modal is closed
                }
            }
            function openTransactionModal(transactionId = null) {
                transactionForm.reset();
                const titleEl = document.getElementById('transaction-modal-title');
                if (transactionId) {
                    titleEl.textContent = 'Edit Transaction';
                    document.getElementById('transaction-id').value = transactionId;
                    const transaction = allTransactions.find(t => t.id === transactionId);
                    if(transaction) {
                        document.getElementById('transaction-account').value = transaction.accountId;
                        document.getElementById('transaction-date').value = transaction.date;
                        document.getElementById('transaction-type').value = transaction.type;
                        document.getElementById('transaction-description').value = transaction.description;
                        document.getElementById('transaction-amount').value = transaction.amount;
                        document.getElementById('transaction-category').value = transaction.category;
                    }
                } else {
                    titleEl.textContent = 'Add Transaction';
                    document.getElementById('transaction-id').value = '';
                    document.getElementById('transaction-date').value = new Date().toLocaleDateString('en-CA');
                }
                openModal(transactionModal);
            }

            function openEditAccountModal(accountId) {
                const account = data.accounts.find(a => a.id === accountId);
                if (account) {
                    document.getElementById('edit-account-id').value = account.id;
                    document.getElementById('edit-account-name').value = account.name;
                    document.getElementById('edit-account-type').value = account.type;
                    openModal(editAccountModal);
                }
            }

            function openConfirmModal(message, callback) {
                document.getElementById('confirm-modal-text').textContent = message;
                confirmCallback = callback;
                openModal(confirmModal);
            }

            // --- CHARTING ---
            function updateCharts(accountId, transactions) {
                const allMonthlyData = allTransactions.reduce((acc, t) => {
                    const month = new Date(t.date).toLocaleString('default', { month: 'short', year: '2-digit'});
                    if (!acc[month]) acc[month] = { income: 0, expense: 0 };
                    if (t.type === 'credit') acc[month].income += t.amount; else acc[month].expense += t.amount;
                    return acc;
                }, {});

                const maxFlow = Object.values(allMonthlyData).reduce((max, monthData) => {
                    return Math.max(max, monthData.income, monthData.expense);
                }, 0);
                
                const suggestedYAxisMax = maxFlow > 0 ? maxFlow * 1.1 : 1000;

                renderMonthlyFlowChart(transactions, suggestedYAxisMax);
                renderCategorySpendingChart(transactions);
            }
            
            function renderMonthlyFlowChart(transactions, suggestedMax) {
                const ctx = document.getElementById('monthly-flow-chart').getContext('2d');
                if (chartInstances.monthly) chartInstances.monthly.destroy();
                const monthlyData = transactions.reduce((acc, t) => {
                    const month = new Date(t.date).toLocaleString('default', { month: 'short', year: '2-digit'});
                    if (!acc[month]) acc[month] = { income: 0, expense: 0 };
                    if (t.type === 'credit') acc[month].income += t.amount; else acc[month].expense += t.amount;
                    return acc;
                }, {});
                const labels = Object.keys(monthlyData).sort((a,b) => new Date('01 ' + a) - new Date('01 ' + b));
                chartInstances.monthly = new Chart(ctx, { type: 'bar', data: { labels, datasets: [ { label: 'Income', data: labels.map(l => monthlyData[l].income), backgroundColor: 'rgba(34, 197, 94, 0.5)'}, { label: 'Expenses', data: labels.map(l => monthlyData[l].expense), backgroundColor: 'rgba(239, 68, 68, 0.5)'} ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, suggestedMax: suggestedMax, grid: { color: '#334155' } }, x: { grid: { color: '#334155' } } }}});
            }

            function renderCategorySpendingChart(transactions) {
                const ctx = document.getElementById('category-spending-chart').getContext('2d');
                if (chartInstances.category) chartInstances.category.destroy();
                const categoryData = transactions.filter(t => t.type === 'debit').reduce((acc, t) => {
                    if (!acc[t.category]) acc[t.category] = 0; acc[t.category] += t.amount; return acc;
                }, {});
                chartInstances.category = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(categoryData), datasets: [{ data: Object.values(categoryData), backgroundColor: ['#ef4444', '#3b82f6', '#eab308', '#22c55e', '#8b5cf6', '#f97316', '#64748b'], borderColor: '#1e293b', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } }}}});
            }

            // --- UTILITY FUNCTIONS ---
            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(amount);
            }

            // --- START THE APPLICATION ---
            setupEventListeners();
            refreshUI(); // Initial render
        });
    </script>
</body>
</html>


